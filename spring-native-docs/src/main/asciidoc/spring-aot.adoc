[[spring-aot]]
== Spring AOT

Spring AOT build plugins are designed to generate and compile sources by taking advantage of the context of your application (classpath, configuration) in order to improve native image compatibility and footprint.
It is invoked before running your application and tests, and may potentially require additional IDE configuration.

=== Maven

The plugin should be declared as following:

====
[source,xml,subs="attributes,verbatim",role="primary"]
.Maven
----
<build>
    <plugins>
        <!-- ... -->
        <plugin>
            <groupId>org.springframework.experimental</groupId>
            <artifactId>spring-aot-maven-plugin</artifactId>
            <version>{version}</version>
            <executions>
                <execution>
                    <id>test-generate</id>
                    <goals>
                        <goal>test-generate</goal>
                    </goals>
                </execution>
                <execution>
                    <id>generate</id>
                    <goals>
                        <goal>generate</goal>
                    </goals>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
----
====

Maven goals `spring-aot:generate` (`process-test-classes` phase) and `spring-aot:test-generate` (`prepare-package` phase) should be invoked automatically in the Maven lifecycle when using the `mvn` command.

Sources are generated in `target/generated-sources/spring-aot/src/main/resources/META-INF/native-image/org.springframework.aot/spring-aot` and test sources in `target/generated-test-sources/spring-aot/src/main/resources/META-INF/native-image/org.springframework.aot/spring-aot`.

Configuration can be performed if needed within the `<configuration>` element, for example to remove SpEL support at build-time if your application does not use it in order to optimize the footprint:

====
[source,xml,subs="attributes,verbatim"]
----
<configuration>
    <removeSpelSupport>true</removeSpelSupport>
</configuration>
----
====

See <<configuring-spring-aot>> for a list of the

==== Intellij IDEA

If build/run actions are not delegated to Maven (default), you may want to https://www.jetbrains.com/help/idea/work-with-maven-goals.html#trigger_goal[configure triggers for Maven goals] as following.

In the Maven tool window, go to "Plugins" and map:

- Right click on `spring-aot:generate` then click on "After build".
- Add the JUnit configuration (or just try to run a firs time your tests) and then right click on `spring-aot:test-generate` then  click on "Execute Run/Debug ..." then select your JUnit test configurations.

If build/run actions are delegated to Maven, it should work out-of-the-box.

==== Eclipse

Eclipse should configure out of the box the main generated sources, so the application should run out of the box with the sources generated by the Spring AOT plugin.

But Eclipse does not support having the same classes in main and test generated sources, so test sources generation is disabled by default and tests should run without the sources generated by the Spring AOT plugin in the IDE.

==== VS code

TODO


=== Gradle

TODO

[[configuring-spring-aot]]
=== Configuring Spring AOT

* `mode` switches how much configuration the feature actually provides to the native image compiler:
** `native` (default) provides resource, initialization, proxy and reflection (using auto-configuration hints) configuration for native images as well as substitutions.
** `native-init` should be used if only wishing to provide initialization configuration and substitutions.
** `native-agent` is using the configuration generated by the tracing agent as a basis and also provides additional hints for components like controllers, etc.

* `debugVerify` is set to `false` by default and enables verification debug when set to `true`.

* `removeXmlSupport` is set to `true` by default to optimize the footprint, setting it to `false` restores Spring XML support (XML converters, codecs and XML application context support).

* `removeSpelSupport` is set to `false` by default, setting it to `true` removes Spring SpEL support to optimize the footprint (should be used only on applications not requiring SpEL).

* `removeYamlSupport` is set to `false` by default, setting it to `true` removes Spring Boot Yaml support to optimize the footprint.

* `removeJmxSupport` is set to `true` by default to optimize the footprint, setting it to `false` restores Spring Boot JMX support.

* `verify` is set to `true` by default and perform some automated verification to ensure your application is native compliant, setting it to `false` switches off the verifications.

* `removeUnusedConfig` is set to`tue` by default, setting it to `false` disables the removal of unused configurations.

* `failOnMissingSelectorHint` is set to `true` by default and throw an error if no hint is provided for an active selector, setting it to `false` switches the plugin from a hard error to a warning. See the Troubleshooting section for more details on this.

* [Experimental] `buildTimePropertiesMatchIfMissing` is set to `true` by default. Setting it to `false` means for any properties specifying `matchIfMissing=true` that will be overridden and not respected. This does flip the application into a mode where it needs to be much more explicit
about specifying properties that activate configurations. (This is a work in dev option really for experimenting with image size vs explicit property trade offs).

* [Experimental] `buildTimePropertiesChecks` (experimental) switches on build time evaluation of some configuration conditions related to properties. It must include at least an initial setting of `default-include-all` or `default-exclude-all` and that may be followed
by a comma separated list of prefixes to explicitly include or exclude (for example `default-include-all,!spring.dont.include.these.,!or.these` or `default-exclude-all,spring.include.this.one.though.,and.this.one`). When considering a property the
longest matching prefix in this setting will apply (in cases where a property matches multiple prefixes).

